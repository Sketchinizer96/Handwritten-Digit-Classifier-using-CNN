import xlwings as xw
import requests
import time
import base64

# Step 1: Set your username and password for Basic Authentication
username = 'your_username'
password = 'your_password'

# Encode the username and password using base64 encoding
credentials = f"{username}:{password}"
encoded_credentials = base64.b64encode(credentials.encode()).decode()

# Step 2: Open the Excel file using xlwings
file_path = 'path_to_your_file.xlsx'
wb = xw.Book(file_path)  # Open the Excel file
sheet = wb.sheets[0]     # Select the first sheet

# Step 3: Automatically determine the last row in the first column (column A)
last_row = sheet.range('A' + str(sheet.cells.last_cell.row)).end('up').row

# Read the IDs from the first column dynamically (column A)
ids = sheet.range(f'A2:A{last_row}').value  # Adjust to start from row 2 if needed

# Loop through each ID, send the request, and update Excel in real-time
for i, id_value in enumerate(ids, start=2):  # Start from row 2
    # Construct the URL with the current ID
    url = f"http://example.com/api/resource/{id_value}"
    
    # Prepare the headers with Basic Authentication
    headers = {
        'Authorization': f'Basic {encoded_credentials}',
        'Content-Type': 'application/json'
    }
    
    # Send the GET request
    response = requests.get(url, headers=headers)
    
    # Parse the response to get the count (assuming JSON response)
    if response.status_code == 200:
        data = response.json()
        count = data.get('count', 0)  # Get 'count' from the response
    else:
        count = 0  # Set count to 0 if request fails
    
    # Step 4: Write the response count to the corresponding Excel cell (Column B)
    sheet.range(f'B{i}').value = count
    
    # Print progress to console
    print(f"Processed ID {id_value} - Count: {count}")
    
    # Step 5: Save the workbook after each update (optional)
    wb.save(file_path)
    
    # Step 6: Add a delay of 5 seconds between requests
    time.sleep(5)

# Close the workbook (optional, keep it open if needed)
# wb.close()

print("Process completed.")