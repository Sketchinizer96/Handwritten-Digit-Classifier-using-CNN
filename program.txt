import xlwings as xw
import requests
import time
import base64
import concurrent.futures

# Replace with actual credentials
username = 'admin'
password = 'your_password'

# Encode the credentials for basic authentication
credentials = f"{username}:{password}"
encoded_credentials = base64.b64encode(credentials.encode()).decode()

# File path input
file_path = input("Please enter excel path: ")
wb = xw.Book(file_path)
sheet = wb.sheets[0]

# Find the last row with data in column A
last_row = sheet.range('A' + str(sheet.cells.last_cell.row)).end('up').row
ids = sheet.range(f"A2:A{last_row}").value

# Function to process each API request
def fetch_api_data(id_value):
    url = f"http://your_api_endpoint/{id_value}"
    headers = {
        'Authorization': f'Basic {encoded_credentials}',
        'Content-Type': 'application/json'
    }
    
    try:
        response = requests.get(url, headers=headers)
        if response.status_code == 200:
            data = response.json()
            count = data.get("count", 0)
        else:
            count = 0
    except Exception as e:
        print(f"Error processing ID {id_value}: {e}")
        count = 0

    return id_value, count  # Return the ID and the result count

# Collect all the API data using ThreadPoolExecutor
results = []
with concurrent.futures.ThreadPoolExecutor(max_workers=5) as executor:
    futures = {executor.submit(fetch_api_data, id_value): i for i, id_value in enumerate(ids, start=2)}
    for future in concurrent.futures.as_completed(futures):
        id_value, count = future.result()
        results.append((id_value, count))

# Now write the results to Excel (main thread)
for row, (id_value, count) in enumerate(results, start=2):
    sheet.range(f'B{row}').value = count
    print(f"Processed ID {id_value} - Count: {count}")

# Save the workbook after processing
wb.save(file_path)

print("Process completed."))