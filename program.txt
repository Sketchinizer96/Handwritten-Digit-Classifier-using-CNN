import xlwings as xw
import requests
import os
import re
from urllib.parse import unquote

# File path input
file_path = input("Please enter the Excel path: ")
wb = xw.Book(file_path)
sheet = wb.sheets[0]

# Find the last row with data in column A (Image IDs)
last_row = sheet.range('A' + str(sheet.cells.last_cell.row)).end('up').row
image_ids = sheet.range(f"A2:A{last_row}").value  # Image ID column
file_names = sheet.range(f"B2:B{last_row}").value  # Filename column (optional)
folder_names = sheet.range(f"C2:C{last_row}").value  # Folder column

# Function to download and save the file
def download_file(image_id, file_name, folder_name):
    # Base API endpoint
    url = f"http://your_api_endpoint?image_id={image_id}"
    
    headers = {
        'Authorization': 'Bearer your_token',  # Add your authorization token or headers here
    }
    
    try:
        response = requests.get(url, headers=headers)
        if response.status_code == 200:
            # Ensure the folder exists or create it
            os.makedirs(folder_name, exist_ok=True)
            
            # If the filename is not provided, use the one from the API response
            if not file_name:
                content_disp = response.headers.get('Content-Disposition', '')
                file_name = re.findall('filename="(.+)"', content_disp)
                file_name = unquote(file_name[0]) if file_name else f"{image_id}.bin"  # Fallback if no filename in headers
            
            # Construct the full path to save the file
            full_path = os.path.join(folder_name, file_name)
            
            # Save the file
            with open(full_path, 'wb') as f:
                f.write(response.content)
            
            return f"Success - Saved as {file_name}"
        else:
            return f"Failed - Status code {response.status_code}"
    except Exception as e:
        return f"Error: {e}"

# Iterate over each row in the Excel sheet and process the records
for i, (image_id, file_name, folder_name) in enumerate(zip(image_ids, file_names, folder_names), start=2):
    if image_id and folder_name:  # Ensure necessary fields are present
        # Call the download function
        status = download_file(image_id, file_name, folder_name)
        
        # Write the status in column D
        sheet.range(f'D{i}').value = status
        print(f"Processed Image ID {image_id} - Status: {status}")
    else:
        sheet.range(f'D{i}').value = "Missing Image ID or Folder"
        print(f"Skipped Image ID {image_id} - Missing ID or Folder")

# Save the workbook after processing
wb.save(file_path)

print("Process completed.")